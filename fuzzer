#!/usr/bin/env php
<?php

declare(strict_types=1);

require __DIR__ . '/vendor/autoload.php';

use Mgrunder\RelayUnifiedDbFuzzer\Fuzzer\FuzzerApplication;
use Mgrunder\RelayUnifiedDbFuzzer\Fuzzer\FuzzerOptions;
use Mgrunder\RelayUnifiedDbFuzzer\Support\ArgvParser;

function usage(): void
{
    fwrite(STDERR, <<<TXT
Relay shared cache fuzzer

Usage:
  ./fuzzer --php <path> --php-ini <path> --ops <int> --runs <int> --workers <int> --mode <fork|cli-server> [options]

Options:
  --commands <csv>        CSV of command families or specific commands to allow
  --host <host>           CLI server host (default 127.0.0.1)
  --port <port>           CLI server port (default 8080)
  --redis-host <host>     Redis host (default localhost)
  --redis-port <port>     Redis port (default 6379)
  --seed <u64>            Master seed (random if omitted)
  --reproducers-dir <dir> Directory for reproducers (default ./reproducers)
  --log-level <level>     Log verbosity (debug, info, notice, warning, error)

TXT);
}

try {
    $parser = new ArgvParser($_SERVER['argv']);
    if ($parser->has('help')) {
        usage();
        exit(0);
    }

    $php = $parser->require('php');
    $phpIni = $parser->require('php-ini');
    $ops = $parser->requireInt('ops');
    $runs = $parser->requireInt('runs');
    $workers = $parser->requireInt('workers');
    $mode = strtolower($parser->require('mode'));
    if (!in_array($mode, ['fork', 'cli-server'], true)) {
        throw new InvalidArgumentException('Mode must be "fork" or "cli-server"');
    }

    $commands = array_map('strtolower', $parser->csv('commands'));
    $seed = $parser->optionalInt('seed');
    $host = $parser->get('host', '127.0.0.1') ?? '127.0.0.1';
    $port = (int)($parser->get('port', '8080') ?? '8080');
    $redisHost = $parser->get('redis-host', 'localhost') ?? 'localhost';
    $redisPort = (int)($parser->get('redis-port', '6379') ?? '6379');
    $reproducersDir = $parser->get('reproducers-dir', 'reproducers') ?? 'reproducers';
    $logLevel = strtolower($parser->get('log-level', 'info') ?? 'info');

    $options = new FuzzerOptions(
        phpBinary: $php,
        phpIni: $phpIni,
        ops: $ops,
        runs: $runs,
        workers: $workers,
        mode: $mode,
        commands: $commands,
        seed: $seed,
        host: $host,
        port: $port,
        redisHost: $redisHost,
        redisPort: $redisPort,
        reproducersDir: $reproducersDir,
        logLevel: $logLevel,
    );

    $logger = Mgrunder\RelayUnifiedDbFuzzer\Support\LoggerFactory::create('fuzzer', $logLevel);
    $app = new FuzzerApplication($options, __DIR__, $logger);
    exit($app->run());
} catch (Throwable $e) {
    fwrite(STDERR, $e->getMessage() . PHP_EOL);
    usage();
    exit(1);
}
