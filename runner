#!/usr/bin/env php
<?php

declare(strict_types=1);

require __DIR__ . '/vendor/autoload.php';

use Mgrunder\RelayUnifiedDbFuzzer\Runner\RunnerApplication;
use Mgrunder\RelayUnifiedDbFuzzer\Runner\RunnerOptions;
use Mgrunder\RelayUnifiedDbFuzzer\Support\ArgvParser;

try {
    $parser = new ArgvParser($_SERVER['argv']);
    if ($parser->has('help')) {
        fwrite(STDERR, "Usage: runner --php <path> --ops <int> --seed <int> [--workers <int>] [--concurrent-requests <int>] --mode <fork|cli-server> [--php-ini <path> --redis-host <host> --redis-port <port> --log-level <level> --cli-server-hold --rr --rr-trace-dir <dir>]\n");
        exit(0);
    }

    $php = $parser->require('php');
    $phpIni = $parser->get('php-ini');
    $ops = $parser->requireInt('ops');
    $seed = $parser->requireInt('seed');
    $workers = $parser->optionalInt('workers', 1) ?? 1;
    $concurrentRequests = $parser->optionalInt('concurrent-requests', $workers) ?? $workers;
    if ($concurrentRequests < 1) {
        throw new InvalidArgumentException('Concurrent requests must be at least 1');
    }
    $mode = strtolower($parser->require('mode'));
    if (!in_array($mode, ['fork', 'cli-server'], true)) {
        throw new InvalidArgumentException('Mode must be "fork" or "cli-server"');
    }

    $cwd = getcwd() ?: __DIR__;
    if (!str_starts_with($php, '/')) {
        $candidate = $cwd . '/' . $php;
        $real = realpath($candidate);
        $php = $real !== false ? $real : $candidate;
    }
    if ($phpIni !== null && !str_starts_with($phpIni, '/')) {
        $candidate = $cwd . '/' . $phpIni;
        $real = realpath($candidate);
        $phpIni = $real !== false ? $real : $candidate;
    }

    $commands = array_map('strtolower', $parser->csv('commands'));
    $artifactDir = $parser->get('artifact-dir');
    $rr = $parser->has('rr');
    $rrTraceDir = $parser->get('rr-trace-dir');
    $host = $parser->get('host', '127.0.0.1') ?? '127.0.0.1';
    $port = (int)($parser->get('port', '8080') ?? '8080');
    $redisHost = $parser->get('redis-host', 'localhost') ?? 'localhost';
    $redisPort = (int)($parser->get('redis-port', '6379') ?? '6379');
    $logLevel = strtolower($parser->get('log-level', 'info') ?? 'info');
    $cliServerHold = $parser->has('cli-server-hold');

    if ($rrTraceDir !== null && !str_starts_with($rrTraceDir, '/')) {
        $candidate = $cwd . '/' . $rrTraceDir;
        $real = realpath($candidate);
        $rrTraceDir = $real !== false ? $real : $candidate;
    }

    if ($rr && getenv('RELAY_RR_WRAPPED') !== '1') {
        $traceRoot = $rrTraceDir;
        if ($traceRoot === null) {
            $base = $artifactDir ?? (sys_get_temp_dir() . '/relay-rr-' . uniqid());
            $traceRoot = $base . '/rr';
        }

        if (!is_dir($traceRoot) && !mkdir($traceRoot, 0777, true) && !is_dir($traceRoot)) {
            throw new RuntimeException(sprintf('Failed to create rr trace directory "%s"', $traceRoot));
        }

        putenv('RELAY_RR_WRAPPED=1');
        putenv('_RR_TRACE_DIR=' . $traceRoot);
        putenv('RELAY_RR_TRACE_DIR=' . $traceRoot);

        $cmd = ['rr', 'record', $php];
        if ($phpIni !== null) {
            $cmd[] = '-c';
            $cmd[] = $phpIni;
        }
        $cmd[] = __FILE__;
        $cmd = array_merge($cmd, array_slice($_SERVER['argv'], 1));
        $cmdLine = implode(' ', array_map('escapeshellarg', $cmd));
        passthru($cmdLine, $status);
        exit($status);
    }

    $options = new RunnerOptions(
        phpBinary: $php,
        phpIni: $phpIni,
        ops: $ops,
        workers: $workers,
        concurrentRequests: $concurrentRequests,
        seed: $seed,
        mode: $mode,
        artifactDir: $artifactDir,
        rr: $rr,
        rrTraceDir: $rrTraceDir,
        commands: $commands,
        host: $host,
        port: $port,
        redisHost: $redisHost,
        redisPort: $redisPort,
        logLevel: $logLevel,
        cliServerHold: $cliServerHold,
    );

    $logger = Mgrunder\RelayUnifiedDbFuzzer\Support\LoggerFactory::create('runner', $logLevel);
    $app = new RunnerApplication($options, __DIR__, $logger);
    exit($app->run());
} catch (Throwable $e) {
    fwrite(STDERR, $e->getMessage() . PHP_EOL);
    exit(1);
}
